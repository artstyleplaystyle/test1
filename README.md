# Coffee Feed — бесконечная лента карточек кофе

Интерактивная лента карточек с сортами кофе, с серверным кешированием и устойчивыми запросами ко внешним источникам. Проект выполнен на SvelteKit + TypeScript + PostCSS. Поддерживает touch и desktop, скелетоны, автодогрузку при бездействии и логи серверной части.

## Демо
- Продакшн: https://<your-vercel-app>.vercel.app (добавьте ссылку после деплоя)
- Скриншот/скринкаст: docs/screencast.mp4 (опционально)

## Основные фичи
- SSR: первая карточка приходит с сервера.
- Серверный кеш: последняя карточка хранится в памяти процесса и в файлах `.server-cache/last_card.{type}.json`; при повторных открытиях используется кеш без запросов во внешние источники.
- Добавление по кнопке: блокировка кнопки во время загрузки + скелетон.
- Автодогрузка: если 30 секунд нет действий — автоматически подгружается ещё одна карточка каждые 30 сек.
- Надёжность: дедупликация параллельных запросов, ретраи с экспоненциальной задержкой, таймауты, логирование.
- UX: плейсхолдер для картинок, плавная анимация, горизонтальный скролл тегов `ingredients` на touch/desktop.

## Стек
- SvelteKit ^2, Svelte ^4
- TypeScript ^5
- PostCSS (autoprefixer, nesting)
- Playwright для E2E

## Установка и запуск локально
```bash
npm i
npm run dev       # http://localhost:5173 (HMR)
npm run build     # продакшн-сборка
npm run preview   # локальный сервер продакшн-сборки
npm run test:e2e  # e2e тесты (Playwright)
```

## API
- `GET /api/initial?type=hot|iced` — вернуть стартовую карточку (из кеша, либо загрузить и закешировать).
- `POST /api/next?type=hot|iced` — вернуть следующую карточку и закешировать как последнюю.

Ответ имеет форму:
```json
{
  "id": 123,
  "title": "...",
  "description": "...",
  "ingredients": ["..."],
  "image": "https://..."
}
```

## Кеширование
- В памяти процесса (LRU) — быстрый путь.
- Persist в файловой системе: `.server-cache/last_card.hot.json` и `.server-cache/last_card.iced.json`.
- Дополнительно (опционально) поддержан Vercel KV для кросс-инстанс персистентности.

> На бессерверных платформах файловый кеш не гарантирован между деплоями/перезапусками. Для стабильной персистентности используйте Vercel KV.

## Деплой на Vercel
1. Подготовьте репозиторий (GitHub/GitLab/Bitbucket).
2. Войдите в https://vercel.com и нажмите "New Project" → "Import" ваш репозиторий.
3. Vercel автоматически определит фреймворк: "SvelteKit".
   - Build Command: `npm run build`
   - Output: автоматически (адаптер auto)
4. (Опционально) Настройте переменные окружения для Vercel KV, чтобы кеш переживал перезапуски и масштабирование:
   - `KV_REST_API_URL`
   - `KV_REST_API_TOKEN`
   
   Добавьте их в Settings → Environment Variables (Production/Preview/Development по необходимости).
5. Нажмите Deploy. После билда получите URL вида `https://<your-vercel-app>.vercel.app`.

### Проверка после деплоя
- Откройте главную страницу — должна отобразиться 1 карточка сразу (SSR).
- Нажмите «Добавить карточку» — должна добавиться новая карточка, кнопка временно заблокируется.
- Попробуйте API напрямую:
  - `GET https://<your-vercel-app>.vercel.app/api/initial?type=hot`
  - `POST https://<your-vercel-app>.vercel.app/api/next?type=iced`

### Замечания по продакшену
- Без Vercel KV сервер может терять кеш между рестартами (например, при ребалансе). Подключение KV решает этот кейс.
- Источники данных: `api.sampleapis.com`. При сетевых сбоях срабатывают ретраи и таймауты.

## Тестирование
- Локально: `npm run test:e2e` (Playwright скачает браузеры при первом запуске).
- Можно запускать E2E в CI перед деплоем.

## Лицензия
MIT (или укажите иную, если требуется)